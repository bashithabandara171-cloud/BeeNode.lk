<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mobile Place Calendar</title>
<style>
  body {font-family:Arial,sans-serif;margin:0;background:white;color:black;}
  .container {max-width:1200px;margin:0 auto;padding:10px;text-align:center;}
  header {display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:10px;margin-bottom:10px;}
  button,label.upload-btn {padding:10px 15px;font-size:15px;cursor:pointer;border:none;border-radius:6px;flex:1 1 auto;min-width:100px;}
  button {background:#007bff;color:white;}
  label.upload-btn {background:#28a745;color:white;}
  h1 {margin:5px 0;font-size:24px;width:100%;}
  input[type=file]{display:none;}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);border:2px solid #000;}
  .day-name,.day{border:1px solid #ccc;padding:5px;min-height:90px;box-sizing:border-box;position:relative;}
  .day-name{background:#f3f3f3;font-weight:bold;}
  .day-number{position:absolute;top:5px;right:8px;font-weight:bold;font-size:14px;}
  .event-text{margin-top:25px;font-size:15px;word-wrap:break-word;}
  .other-month{color:#bbb;}
  .filled{background:#fff7c2;}
  .event-photo{margin-top:5px;width:100%;max-height:70px;object-fit:cover;border-radius:5px;}
  #status{margin-top:8px;font-size:14px;color:#555;}
  @media(max-width:600px){
    h1{font-size:20px;}
    button,label.upload-btn{font-size:13px;padding:8px 10px;}
    .day{min-height:70px;font-size:13px;}
    .event-text{font-size:13px;}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <button id="prevMonth">â—€ Prev</button>
    <h1 id="monthYear">Month Year</h1>
    <button id="nextMonth">Next â–¶</button>
    <button id="todayBtn">Today</button>
    <label for="fileInput" class="upload-btn">ðŸ“„ Upload TXT/IMG/PDF</label>
    <input type="file" id="fileInput" accept=".txt,image/*,.pdf">
    <button id="exportPDF" style="background:#9c27b0;color:white;">ðŸ“• Export PDF</button>
    <div id="status"></div>
  </header>
  <div class="calendar" id="calendar"></div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let currentDate = new Date();
let events = JSON.parse(localStorage.getItem("calendarEvents") || "{}");

function renderCalendar(date){
  const year=date.getFullYear(),month=date.getMonth();
  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);
  const startDay=first.getDay(),daysInMonth=last.getDate();
  document.getElementById("monthYear").textContent=date.toLocaleString("default",{month:"long",year:"numeric"});
  const calendar=document.getElementById("calendar");
  calendar.innerHTML="";
  const dayNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  dayNames.forEach(d=>{
    const div=document.createElement("div");
    div.textContent=d;
    div.className="day-name";
    calendar.appendChild(div);
  });
  for(let i=0;i<startDay;i++){
    const div=document.createElement("div");
    div.className="day other-month";
    calendar.appendChild(div);
  }
  for(let i=1;i<=daysInMonth;i++){
    const div=document.createElement("div");
    div.className="day";
    const num=document.createElement("div");
    num.className="day-number";
    num.textContent=i;
    div.appendChild(num);

    if(events[i]){
      if(events[i].place){
        const txt=document.createElement("div");
        txt.className="event-text";
        txt.textContent=events[i].place;
        div.classList.add("filled");
        div.appendChild(txt);
      }
      if(events[i].photo){
        const img=document.createElement("img");
        img.src=events[i].photo;
        img.className="event-photo";
        div.appendChild(img);
      }
    }

    div.addEventListener("dblclick",()=>{
      const place=prompt("Enter place name for day "+i+":",events[i]?.place||"");
      if(place!==null){
        if(!events[i])events[i]={};
        events[i].place=place.trim();
        saveEvents();
        renderCalendar(currentDate);
      }
    });

    div.addEventListener("click",()=>{
      const input=document.createElement("input");
      input.type="file";
      input.accept="image/*";
      input.onchange=e=>{
        const file=e.target.files[0];
        if(!file)return;
        const reader=new FileReader();
        reader.onload=ev=>{
          if(!events[i])events[i]={};
          events[i].photo=ev.target.result;
          saveEvents();
          renderCalendar(currentDate);
        };
        reader.readAsDataURL(file);
      };
      input.click();
    });

    calendar.appendChild(div);
  }
}

function saveEvents(){
  localStorage.setItem("calendarEvents",JSON.stringify(events));
}

function parseLines(text){
  const lines=text.split(/\r?\n/);
  lines.forEach(line=>{
    const parts=line.trim().split(/\s+/);
    if(parts.length>=2){
      const day=parseInt(parts[0],10);
      if(!isNaN(day)){
        const place=line.replace(/^\d+\s*/, '').trim();
        if(place){
          if(!events[day])events[day]={};
          events[day].place=place;
        }
      }
    }
  });
  saveEvents();
  renderCalendar(currentDate);
}

// ---------- Handle file uploads ----------
document.getElementById("fileInput").addEventListener("change",async e=>{
  const file=e.target.files[0];
  if(!file)return;
  const status=document.getElementById("status");
  status.textContent="Processing file...";
  const ext=file.name.split('.').pop().toLowerCase();

  if(ext==="txt"){
    const reader=new FileReader();
    reader.onload=ev=>parseLines(ev.target.result);
    reader.readAsText(file);
  }
  else if(ext==="pdf"){
    const pdfData=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:pdfData}).promise;
    let fullText="";
    for(let i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const viewport=page.getViewport({scale:2});
      const canvas=document.createElement("canvas");
      const context=canvas.getContext("2d");
      canvas.height=viewport.height;
      canvas.width=viewport.width;
      await page.render({canvasContext:context,viewport:viewport}).promise;
      const imgData=canvas.toDataURL("image/png");
      const {data:{text}}=await Tesseract.recognize(imgData,'eng');
      fullText+=text+"\n";
      status.textContent=`Processing PDF page ${i}/${pdf.numPages}...`;
    }
    status.textContent="âœ… PDF recognized. Filling calendar.";
    parseLines(fullText);
  }
  else{
    const reader=new FileReader();
    reader.onload=ev=>{
      Tesseract.recognize(ev.target.result,'eng',{logger:m=>status.textContent='OCR: '+Math.round(m.progress*100)+'%'})
      .then(({data:{text}})=>{
        status.textContent="âœ… Image recognized.";
        parseLines(text);
      })
      .catch(err=>status.textContent="âŒ "+err.message);
    };
    reader.readAsDataURL(file);
  }
});

// ---------- Export PDF ----------
document.getElementById("exportPDF").addEventListener("click",async()=>{
  const calendar=document.querySelector(".calendar");
  const canvas=await html2canvas(calendar,{scale:2});
  const imgData=canvas.toDataURL("image/png");
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("l","pt","a4");
  const pageWidth=pdf.internal.pageSize.getWidth();
  const pageHeight=pdf.internal.pageSize.getHeight();
  const ratio=Math.min(pageWidth/canvas.width,pageHeight/canvas.height);
  const x=(pageWidth-canvas.width*ratio)/2;
  const y=(pageHeight-canvas.height*ratio)/2;
  pdf.addImage(imgData,"PNG",x,y,canvas.width*ratio,canvas.height*ratio);
  pdf.save(`${document.getElementById("monthYear").textContent}.pdf`);
});

// ---------- Navigation ----------
document.getElementById("prevMonth").onclick=()=>{currentDate.setMonth(currentDate.getMonth()-1);renderCalendar(currentDate);}
document.getElementById("nextMonth").onclick=()=>{currentDate.setMonth(currentDate.getMonth()+1);renderCalendar(currentDate);}
document.getElementById("todayBtn").onclick=()=>{currentDate=new Date();renderCalendar(currentDate);}

renderCalendar(currentDate);
</script>
</body>
</html>
